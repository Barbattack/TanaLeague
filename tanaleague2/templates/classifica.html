<!-- CLASSIFICA TEMPLATE FINGERPRINT v4 | built 2025-11-07T20:42:05 -->
{% extends "base.html" %}

{% block title %}{{ season.name }} - TanaLeague{% endblock %}
{% block description %}Classifica {{ season.name }} - La Tana delle Pulci{% endblock %}

{% block content %}
{% set status_str = (season.get('status') or season.get('Status') or '') | string | trim | upper %}
{% set is_final = (status_str == 'CLOSED') %}
<div id="stats-shortcut" class="d-flex justify-content-end mb-2">
  <a class="btn btn-secondary btn-sm" href="{{ url_for('stats', scope=season.id) }}">ðŸ“Š Stats {{ season.id }}</a>
</div>
<!-- Header con Dropdown Stagioni -->
<div class="row mb-4">
    <div class="col-md-8">
        <h1><i class="fas fa-ranking-star"></i> {{ season.name }}</h1>
        <p class="text-muted">{{ season.tcg }} - Stagione {{ season.id }}</p>
    </div>
    <div class="col-md-4 text-end">
        <!-- Dropdown Stagioni -->
        <div class="dropdown d-inline-block">
            <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-calendar-alt"></i> Cambia Stagione
            </button>
            <ul class="dropdown-menu">
                {% for s in all_seasons %}
                {% if s.status|upper != 'ARCHIVED' %}
                <li>
                    <a class="dropdown-item {% if s.id == season.id %}active{% endif %}"
                       href="{{ url_for('classifica', season_id=s.id) }}">
                        {{ s.name }}
                        {% if s.status|upper == 'ACTIVE' %}<span class="badge bg-success">Attiva</span>{% endif %}
                    </a>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
        
        <!-- Share Button -->
        <button class="btn btn-primary" onclick="shareClassifica()">
            <i class="fas fa-share-nodes"></i> Condividi
        </button>
    </div>
</div>

<!-- Alert Cache Vecchia -->
{% if is_stale %}
<div class="alert alert-warning" role="alert">
    <i class="fas fa-exclamation-triangle"></i> 
    <strong>Attenzione:</strong> Dati di {{ cache_age }} minuti fa. 
    Prossimo aggiornamento tra {{ 5 - (cache_age % 5) }} minuti.
</div>
{% endif %}

<!-- Metadata -->
<div class="row mb-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-clock"></i> Ultimo Aggiornamento</h6>
                <p class="card-text">{{ cache_age }} minuti fa</p>
            </div>
        </div>
    </div>
    {% if last_tournament %}
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-trophy"></i> Ultimo Torneo</h6>
                <p class="card-text">
                    {{ last_tournament.date }} - Vincitore: <strong>{{ last_tournament.winner }}</strong>
                </p>
            </div>
        </div>
    </div>
    {% endif %}
    {% if season.next_tournament %}
    <div class="col-md-4">
        <div class="card border-success">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-calendar-check"></i> Prossimo Torneo</h6>
                <p class="card-text text-success"><strong>{{ season.next_tournament }}</strong></p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Spinner (nascosto dopo caricamento) -->
<div id="loading" class="text-center my-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Caricamento...</span>
    </div>
    <p class="mt-2">Caricamento classifica... mancano pochi secondi!</p>
</div>

<!-- Tabella Classifica -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
      <i class="fas fa-list-ol"></i>
      {% if is_final %}
        Classifica Stagionale Definitiva
      {% else %}
        Classifica Stagionale Provvisoria
      {% endif %}</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">#</th>
                        <th>Giocatore</th>
                        <th class="text-center">Punti</th>
                        <th class="text-center d-none d-md-table-cell">Giocati</th>
                        <th class="text-center d-none d-md-table-cell">Contati</th>
                        <th class="text-center d-none d-lg-table-cell">Tornei Vinti</th>
                        <th class="text-center d-none d-lg-table-cell">Match Vinti</th>
                        <th class="text-center d-none d-lg-table-cell">Best Rank</th>
                        <th class="text-center d-none d-lg-table-cell">Top 8</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in standings %}
                    <tr {% if loop.index <= 3 %}class="table-warning"{% endif %}>
                        <td class="text-center">
                            {% if loop.index == 1 %}
                                <i class="fas fa-crown text-warning"></i>
                            {% elif loop.index == 2 %}
                                <i class="fas fa-medal text-secondary"></i>
                            {% elif loop.index == 3 %}
                                <i class="fas fa-medal text-bronze"></i>
                            {% else %}
                                {{ loop.index }}
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('player', membership=player.membership) }}" class="text-decoration-none">
                                <strong>{{ player.name|format_player_name(season.tcg, player.membership) }}</strong>
                            </a>
                        </td>
                        <td class="text-center"><strong>{{ player.points|int }}</strong></td>
                        <td class="text-center d-none d-md-table-cell">{{ player.tournaments_played }}</td>
                        <td class="text-center d-none d-md-table-cell">{{ player.tournaments_counted }}</td>
                        <td class="text-center d-none d-lg-table-cell">{{ player.total_wins }}</td>
                        <td class="text-center d-none d-lg-table-cell">{{ player.match_wins }}</td>
                        <td class="text-center d-none d-lg-table-cell">{{ player.best_rank }}</td>
                        <td class="text-center d-none d-lg-table-cell">{{ player.top8_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if is_final %}
<!-- Info Scarto -->
<div class="alert alert-info mt-3" role="alert">
    <i class="fas fa-info-circle"></i> 
    <strong>Nota:</strong> 
    {% set s0 = standings[0] if standings|length > 0 else None %}
{% if s0 and s0.tournaments_counted < s0.tournaments_played %}
        Classifica con scarto delle 2 giornate peggiori.
    {% else %}
        Tutte le giornate contano per la classifica.
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Native Share API
function shareClassifica() {
    if (navigator.share) {
        navigator.share({
            title: '{{ season.name }} - TanaLeague',
            text: 'Guarda la classifica della {{ season.name }}!',
            url: window.location.href
        }).catch(err => {
            // Fallback: copia URL
            navigator.clipboard.writeText(window.location.href);
            alert('Link copiato negli appunti!');
        });
    } else {
        // Fallback per browser senza Share API
        navigator.clipboard.writeText(window.location.href);
        alert('Link copiato negli appunti!');
    }
}

// Mostra spinner al caricamento (opzionale, per future implementazioni AJAX)
// window.addEventListener('load', function() {
//     document.getElementById('loading').style.display = 'none';
// });
</script>
{% endblock %}
