{% extends "base.html" %}
{% block title %}Stats ‚Äì {{ scope }}{% endblock %}
{% block description %}Statistiche complete della lega{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-md-8">
    <h1><i class="fas fa-chart-line"></i> Stats ‚Äì {{ scope }}</h1>
    <p class="text-muted">Statistiche complete della stagione</p>
  </div>
  <div class="col-md-4 text-end">
    <div class="btn-group">
      <a class="btn btn-secondary" href="{{ url_for('classifica', season_id=default_season) }}">
        <i class="fas fa-list-ol"></i> Classifica
      </a>
      <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
          Cambia Stagione
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          {% for s in available_scopes %}
            <li><a class="dropdown-item {% if s==scope %}active{% endif %}" href="{{ url_for('stats', scope=s) }}">{{ s }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- SPOTLIGHTS -->
<div class="mb-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">üéØ Spotlights</h2>
      <p class="text-muted mb-0">I protagonisti della stagione</p>
    </div>
    <button class="btn btn-sm btn-outline-primary" onclick="shareStats('spotlights')">
      <i class="fas fa-share-alt"></i> Condividi
    </button>
  </div>
  
  <div class="row g-3">
    <!-- Dominatore -->
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 border-primary">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üëë</span>
            <div class="text-end">
              <span class="badge bg-primary">min 3</span>
              <span class="ms-1" data-bs-toggle="tooltip" title="Punti √ó presenza √∑ media" style="cursor: help;">‚ÑπÔ∏è</span>
            </div>
          </div>
          <h5 class="card-title">Dominatore</h5>
          <p class="text-muted small mb-3">Pi√π punti considerando presenza</p>
          {% if stats.spotlights.dominatore and stats.spotlights.dominatore|length > 0 %}
            {% for p in stats.spotlights.dominatore[:3] %}
              <div class="{% if loop.first %}fs-4 fw-bold text-primary{% else %}small{% endif %} mb-1">
                {{ loop.index }}. {{ p.name }}
                <span class="{% if loop.first %}fs-6{% endif %} text-muted">{{ p.score }}</span>
                {% if loop.first and p.score > 50 %}<span class="badge bg-success ms-1">Top 10%</span>{% endif %}
              </div>
            {% endfor %}
            <canvas id="spark-dom" width="200" height="30" class="mt-2"></canvas>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Cecchino -->
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 border-success">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üéØ</span>
            <div class="text-end">
              <span class="badge bg-success">min 3</span>
              <span class="ms-1" data-bs-toggle="tooltip" title="Punti √∑ tornei giocati" style="cursor: help;">‚ÑπÔ∏è</span>
            </div>
          </div>
          <h5 class="card-title">Cecchino</h5>
          <p class="text-muted small mb-3">Media punti pi√π alta per torneo</p>
          {% if stats.spotlights.cecchino and stats.spotlights.cecchino|length > 0 %}
            {% for p in stats.spotlights.cecchino[:3] %}
              <div class="{% if loop.first %}fs-4 fw-bold text-success{% else %}small{% endif %} mb-1">
                {{ loop.index }}. {{ p.name }}
                <span class="{% if loop.first %}fs-6{% endif %} text-muted">{{ p.score }}</span>
              </div>
            {% endfor %}
            <canvas id="spark-cec" width="200" height="30" class="mt-2"></canvas>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Costante vs Imprevedibile -->
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 border-warning">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">‚öñÔ∏è</span>
            <div class="text-end">
              <span class="badge bg-warning text-dark">min 3</span>
              <span class="ms-1" data-bs-toggle="tooltip" title="Deviazione standard (œÉ)" style="cursor: help;">‚ÑπÔ∏è</span>
            </div>
          </div>
          <h5 class="card-title">Costante vs Imprevedibile</h5>
          <p class="text-muted small mb-3">Chi varia meno/pi√π</p>
          {% if stats.spotlights.costante_vs_imprevedibile %}
            {% set cv = stats.spotlights.costante_vs_imprevedibile %}
            {% if cv.costante %}
              <div class="mb-2">
                <div class="fw-bold text-success">{{ cv.costante.name }}</div>
                <small class="text-muted">Costante (œÉ: {{ cv.costante.score }})</small>
              </div>
            {% endif %}
            {% if cv.imprevedibile %}
              <div>
                <div class="fw-bold text-warning">{{ cv.imprevedibile.name }}</div>
                <small class="text-muted">Montagne russe (œÉ: {{ cv.imprevedibile.score }})</small>
              </div>
            {% endif %}
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Fenice -->
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 border-danger">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üî•</span>
            <div class="text-end">
              <span class="badge bg-danger">min 3</span>
              <span class="ms-1" data-bs-toggle="tooltip" title="Œî ultimi vs precedenti" style="cursor: help;">‚ÑπÔ∏è</span>
            </div>
          </div>
          <h5 class="card-title">Fenice</h5>
          <p class="text-muted small mb-3">Crescita recente impressionante</p>
          {% if stats.spotlights.fenice and stats.spotlights.fenice|length > 0 %}
            {% for p in stats.spotlights.fenice[:3] %}
              <div class="{% if loop.first %}fs-4 fw-bold text-danger{% else %}small{% endif %} mb-1">
                {{ loop.index }}. {{ p.name }}
                <span class="{% if loop.first %}fs-6{% endif %} text-muted">+{{ p.score }}</span>
              </div>
            {% endfor %}
            <canvas id="spark-fen" width="200" height="30" class="mt-2"></canvas>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Big Match Player -->
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 border-info">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">‚≠ê</span>
            <div class="text-end">
              <span class="badge bg-info">min 3</span>
              <span class="ms-1" data-bs-toggle="tooltip" title="Media in tornei Q3" style="cursor: help;">‚ÑπÔ∏è</span>
            </div>
          </div>
          <h5 class="card-title">Big Match Player</h5>
          <p class="text-muted small mb-3">Top nei tornei pi√π affollati</p>
          {% if stats.spotlights.big_match_player and stats.spotlights.big_match_player|length > 0 %}
            {% for p in stats.spotlights.big_match_player[:3] %}
              <div class="{% if loop.first %}fs-4 fw-bold text-info{% else %}small{% endif %} mb-1">
                {{ loop.index }}. {{ p.name }}
                <span class="{% if loop.first %}fs-6{% endif %} text-muted">{{ p.score }}</span>
              </div>
            {% endfor %}
            <canvas id="spark-big" width="200" height="30" class="mt-2"></canvas>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Finalista -->
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 border-secondary">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üèÅ</span>
            <div class="text-end">
              <span class="badge bg-secondary">min 3</span>
              <span class="ms-1" data-bs-toggle="tooltip" title="% punti da top8" style="cursor: help;">‚ÑπÔ∏è</span>
            </div>
          </div>
          <h5 class="card-title">Finalista</h5>
          <p class="text-muted small mb-3">Pi√π punti da top 8</p>
          {% if stats.spotlights.finalista and stats.spotlights.finalista|length > 0 %}
            {% for p in stats.spotlights.finalista[:3] %}
              <div class="{% if loop.first %}fs-4 fw-bold text-secondary{% else %}small{% endif %} mb-1">
                {{ loop.index }}. {{ p.name }}
                <span class="{% if loop.first %}fs-6{% endif %} text-muted">{{ (p.score * 100)|round(1) }}%</span>
              </div>
            {% endfor %}
            <canvas id="spark-fin" width="200" height="30" class="mt-2"></canvas>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PULSE -->
<div class="mb-5">
  <h2 class="mb-3">üìä Pulse</h2>
  <p class="text-muted mb-4">La salute della lega</p>
  
  <div class="row g-3">
    {% set k = stats.pulse.kpi %}
    
    {% if k.compleanno_lega %}
    <div class="col-md-6 col-lg-3">
      <div class="card h-100 bg-light">
        <div class="card-body text-center">
          <div class="fs-1 mb-2">üéÇ</div>
          <div class="fs-3 fw-bold text-primary">{{ k.compleanno_lega.giorni }}</div>
          <div class="text-muted">Giorni Attivi</div>
          <small class="text-muted">Dal {{ k.compleanno_lega.primo_torneo }}</small>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="col-md-6 col-lg-3">
      <div class="card h-100 bg-light">
        <div class="card-body text-center">
          <div class="fs-1 mb-2">üë•</div>
          <div class="fs-3 fw-bold text-success">{{ k.unique_players }}</div>
          <div class="text-muted">Giocatori Unici</div>
          {% if k.unique_players > 30 %}<span class="badge bg-success mt-1">Community!</span>{% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3">
      <div class="card h-100 bg-light">
        <div class="card-body text-center">
          <div class="fs-1 mb-2">üìà</div>
          <div class="fs-3 fw-bold text-info">{{ k.avg_participants }}</div>
          <div class="text-muted">Media Tavoli</div>
          <canvas id="spark-pulse" width="150" height="25" class="mt-2"></canvas>
        </div>
      </div>
    </div>

    {% if k.record_presenze %}
    <div class="col-md-6 col-lg-3">
      <div class="card h-100 bg-light">
        <div class="card-body text-center">
          <div class="fs-1 mb-2">üî•</div>
          <div class="fs-3 fw-bold text-danger">{{ k.record_presenze.count }}</div>
          <div class="text-muted">Record Presenze</div>
          <small class="text-muted">{{ k.record_presenze.date }}</small>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- TALES -->
<div class="mb-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">üìñ Tales</h2>
      <p class="text-muted mb-0">Storie della community</p>
    </div>
    <button class="btn btn-sm btn-outline-primary" onclick="shareStats('tales')">
      <i class="fas fa-share-alt"></i> Condividi
    </button>
  </div>
  
  <div class="row g-3">
    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
            <span data-bs-toggle="tooltip" title="Coppia che gioca pi√π insieme" style="cursor: help;">‚ÑπÔ∏è</span>
          </div>
          <h5 class="card-title">Duo Inseparabile</h5>
          <p class="text-muted small mb-3">I due che giocano sempre insieme</p>
          {% if stats.tales.companions and stats.tales.companions|length > 0 %}
            {% for d in stats.tales.companions[:3] %}
              <div class="{% if loop.first %}fw-bold{% else %}small text-muted{% endif %} mb-1">
                {{ loop.index }}. {{ d.a.name }} + {{ d.b.name }}
                <span class="badge bg-primary ms-1">{{ d.count }}x</span>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">‚ö°</span>
            <span data-bs-toggle="tooltip" title="Finale epica" style="cursor: help;">‚ÑπÔ∏è</span>
          </div>
          <h5 class="card-title">Match dell'Anno</h5>
          <p class="text-muted small mb-3">Finale tra top player</p>
          {% if stats.tales.match_anno %}
            {% set m = stats.tales.match_anno %}
            <div class="fw-bold">{{ m.a.name }} vs {{ m.b.name }}</div>
            <span class="badge bg-warning text-dark">{{ m.participants }} giocatori</span>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üò±</span>
            <span data-bs-toggle="tooltip" title="9¬∞ posto = fuori top8!" style="cursor: help;">‚ÑπÔ∏è</span>
          </div>
          <h5 class="card-title">Sfortuna Nera</h5>
          <p class="text-muted small mb-3">Fuori top8 per un posto!</p>
          {% if stats.tales.sfortuna_nera %}
            {% set s = stats.tales.sfortuna_nera %}
            <div class="fs-4 fw-bold text-warning">{{ s.name }}</div>
            <div class="text-muted">{{ s.count }}x al 9¬∞</div>
          {% else %}
            <div class="text-success">Nessuno! üçÄ</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">ü§∫</span>
            <span data-bs-toggle="tooltip" title="Podio condiviso" style="cursor: help;">‚ÑπÔ∏è</span>
          </div>
          <h5 class="card-title">Rivalit√† Top</h5>
          <p class="text-muted small mb-3">Sul podio insieme</p>
          {% if stats.tales.podium_rivals and stats.tales.podium_rivals|length > 0 %}
            {% for d in stats.tales.podium_rivals[:3] %}
              <div class="{% if loop.first %}fw-bold{% else %}small text-muted{% endif %} mb-1">
                {{ loop.index }}. {{ d.a.name }} vs {{ d.b.name }}
                <span class="badge bg-danger ms-1">{{ d.count }}x</span>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üÜï</span>
            <span data-bs-toggle="tooltip" title="Ultimo arrivato" style="cursor: help;">‚ÑπÔ∏è</span>
          </div>
          <h5 class="card-title">Ultimo Arrivato</h5>
          <p class="text-muted small mb-3">Il pi√π recente</p>
          {% if stats.tales.ultimo_arrivato %}
            {% set u = stats.tales.ultimo_arrivato %}
            <div class="fs-4 fw-bold text-success">{{ u.name }}</div>
            <div class="text-muted">{{ u.date }}</div>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- HALL OF FAME -->
<div class="mb-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">üèÜ Hall of Fame</h2>
      <p class="text-muted mb-0">I record leggendari</p>
    </div>
    <button class="btn btn-sm btn-outline-primary" onclick="shareStats('hall')">
      <i class="fas fa-share-alt"></i> Condividi
    </button>
  </div>
  
  <div class="row g-3">
    <div class="col-md-6 col-lg-3">
      <div class="card h-100 border-warning">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üéØ</span>
            <span data-bs-toggle="tooltip" title="Vittorie da fondo classifica" style="cursor: help;">‚ÑπÔ∏è</span>
          </div>
          <h5 class="card-title">Underdog Hero</h5>
          <p class="text-muted small mb-3">Rimonte impossibili</p>
          {% if stats.hof.underdog_hero %}
            {% set u = stats.hof.underdog_hero %}
            <div class="fs-4 fw-bold text-warning">{{ u.name }}</div>
            <div class="text-muted">{{ u.wins }} vittorie!</div>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3">
      <div class="card h-100 border-success">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üìà</span>
            <span data-bs-toggle="tooltip" title="Salto in classifica" style="cursor: help;">‚ÑπÔ∏è</span>
          </div>
          <h5 class="card-title">Scalata Epica</h5>
          <p class="text-muted small mb-3">Miglioramento massimo</p>
          {% if stats.hof.scalata_epica %}
            {% set s = stats.hof.scalata_epica %}
            <div class="fs-4 fw-bold text-success">{{ s.name }}</div>
            <div class="text-muted">+{{ s.delta }} posizioni</div>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3">
      <div class="card h-100 border-primary">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">üëë</span>
            <span data-bs-toggle="tooltip" title="Tornei vinti" style="cursor: help;">‚ÑπÔ∏è</span>
          </div>
          <h5 class="card-title">Pi√π Vittorie</h5>
          <p class="text-muted small mb-3">Il campione</p>
          {% if stats.hof.piu_vittorie %}
            {% set v = stats.hof.piu_vittorie %}
            <div class="fs-4 fw-bold text-primary">{{ v.name }}</div>
            <div class="text-muted">{{ v.wins }} tornei</div>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3">
      <div class="card h-100 border-danger">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="fs-1">‚≠ê</span>
            <span data-bs-toggle="tooltip" title="Punti totali" style="cursor: help;">‚ÑπÔ∏è</span>
          </div>
          <h5 class="card-title">Pi√π Punti</h5>
          <p class="text-muted small mb-3">La leggenda</p>
          {% if stats.hof.piu_punti %}
            {% set p = stats.hof.piu_punti %}
            <div class="fs-4 fw-bold text-danger">{{ p.name }}</div>
            <div class="text-muted">{{ p.points }} punti</div>
          {% else %}
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Tooltip Bootstrap
document.addEventListener('DOMContentLoaded', function() {
  var tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltips.map(function(el) { return new bootstrap.Tooltip(el); });
});

// Sparkline
function spark(id, vals, color) {
  const c = document.getElementById(id);
  if (!c || !vals || vals.length === 0) return;
  const ctx = c.getContext('2d');
  const w = c.width, h = c.height;
  const max = Math.max(...vals), min = Math.min(...vals);
  const range = max - min || 1;
  ctx.clearRect(0, 0, w, h);
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.beginPath();
  vals.forEach((v, i) => {
    const x = (i / (vals.length - 1)) * w;
    const y = h - ((v - min) / range) * h;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
}

// Dati esempio - sostituire con backend reali
spark('spark-dom', [45, 48, 52, 50, 55], '#0d6efd');
spark('spark-cec', [14, 15, 16, 15, 17], '#198754');
spark('spark-fen', [10, 12, 15, 18, 20], '#dc3545');
spark('spark-big', [13, 14, 15, 14, 16], '#0dcaf0');
spark('spark-fin', [0.6, 0.65, 0.7, 0.68, 0.72], '#6c757d');
spark('spark-pulse', [12, 13, 14, 15, 14], '#0dcaf0');

// Share
function shareStats(section) {
  const url = window.location.href;
  const text = `Stats ${section} - TanaLeague`;
  if (navigator.share) {
    navigator.share({title: 'TanaLeague', text, url});
  } else {
    navigator.clipboard.writeText(url);
    alert('Link copiato!');
  }
}
</script>

{% endblock %}
